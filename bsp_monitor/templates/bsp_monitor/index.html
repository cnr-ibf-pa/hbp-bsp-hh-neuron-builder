{% load static  %}

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" type="text/css" href="{% static 'hbp-collaboratory-theme/dist/css/bootstrap.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'bspg.css' %}">
        <title>Brain Simulation Platform Monitor</title>
        <script type="text/javascript" src="{% static 'bsp_monitor/js/ga.js' %}"></script>
        <script type="text/javascript" src="{% static 'moment-with-locales.js' %}"></script>
        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
        <script type="text/javascript" src="{% static 'palette.js' %}"></script>
    </head>

    <body onresize="location.reload()">
        <div id="title-div-container" class="fixed-page-title bg-bordeaux">
            <div id="title-div" class="row center-container">
                <h3 id"title">Brain Simulation Platform Monitor</h3>
            </div>
        </div>
        <!-- ********************************** -->
        <!-- REAL TIME PANEL - START -->
        <div class="panel-stat-container">
            <div class="panel panel-info panel-stat-sub-cont row br-7">
                <div class="panel-heading clearfix br-7 center-container">
                    <h4 class="col-sm-3 align-left"><strong>Real-time usage</strong></h4>
                    <button id="refresh-btn" class="btn-link col-sm-9 align-right">Refresh</button>
                </div>
                <div class="panel-body">
                    <!-- main div - start-->
                    <div class="">
                        <!-- google stat - start-->
                        <div class="col-sm-6 stats-big-container">
                            <div class="col-sm-3 align-center">
                                <div class="panel panel-default br-7">
                                    <div class="panel panel-heading">
                                        # users
                                    </div>
                                    <div class="panel panel-content">
                                        <div id="active-users-container" class="center-container rt-boxes">
                                            <p id='active-users-value' class="rt-num vert-align">--</p>
                                        </div>
                                    </div>
                                    <div class="center-container"><i>last 120s</i></div>
                                </div>
                            </div>
                            <div class="col-sm-9 align-center ">
                                <div class="panel panel-default br-7">
                                    <div class="panel panel-heading br-7">
                                        visited pages
                                    </div>
                                    <div class="panel panel-content">
                                        <figure class="rt-boxes vert-align" style="position:relative" id="chart-rt-pages-container"></figure>
                                    </div>
                                    <div class="center-container"><i>last 5min</i></div>
                                </div>
                            </div>
                            <div class="col-sm-12 align-center bottom-bar">
                                Source: google analytics
                            </div>
                        </div>
                        <!-- google stat - end -->

                        <!-- bsp stat - start -->
                        <div class="col-sm-6 align-center">
                            <div class="col-sm-3 align-center">
                                <div class="panel panel-default br-7">
                                    <div class="panel panel-heading br-7">
                                        # use cases
                                    </div>
                                    <div id="current-cloned-container" class="panel panel-content rt-boxes center-container">
                                        <p id='rt-uc-num' class="rt-num">--</p>
                                    </div>
                                    <div class="center-container"><i>last 24h</i></div>
                                </div>
                            </div>
                            <div class="col-sm-9 align-center">
                                <div class="panel panel-default br-7">
                                    <div class="panel panel-heading">
                                        use cases
                                    </div>
                                    <div class="panel panel-content">
                                        <figure class="rt-boxes" id="chart-rt-uc-container"></figure>
                                    </div>
                                    <div class="center-container"><i>last 24h</i></div>
                                </div>
                            </div>
                            <div class="col-sm-12 align-center bottom-bar">
                                Source: BSP analytics
                            </div>
                            <!-- bsp stat - end -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- main div - end -->
            <!-- REAL TIME PANEL - END -->


            <!-- HISTORY PANEL - START -->
            <div class="panel-stat-container">
                <div class="panel panel-info panel-stat-sub-cont br-7">
                    <div class="panel-heading clearfix br-7 center-container">
                        <div class="col-sm-3 align-left">
                            <h4><strong>History</strong></h4>
                        </div>
                        <div class="col-sm-9 align-right">
                            <label for="from-day">From: </label>
                            <input id="from-day" name="from-day" type="date" max="2025-01-01" min="2013-01-01"></input>
                            <span> -  </span>
                            <label for="to-day">To: </label>
                            <input id="to-day" name="to-day" max="2030-01-01" min="2025-01-01" type="date"></input>
                            <button id="apply-btn" class="btn-link">Apply</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="col-sm-6 align-center">
                            <div class="stats-small-container">
                                <h4><strong>Analytics</strong></h4>
                            </div>
                            <div id="google-analytics-div">
                                <div class="uc-t-box" style="padding-top:10px;">
                                    <p style="font-family:Arial,Helvetica,sans-serif; font-size:16px;font-weight:bold; color:#666;">Locations (Google Analytics)</p>
                                    <figure class="hist-boxes center-container" style="width:99%;" id="embed-geo"></figure>
                                </div>
                                <div class="uc-t-box">
                                    <figure class="hist-boxes vert-align" id="session-num"></figure>
                                </div>
                                <div class="uc-t-box">
                                    <figure class="hist-boxes vert-align" id="user-num"></figure>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 align-center">
                            <div class="stats-small-container">
                                <h4><strong>Use case cloning</strong></h4>
                            </div>
                            <div id="uc-hist-div">
                                <div class="chart col-sm-12" id="user-chart2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- HISTORY PANEL - START -->

            <script>

window.onresize = function(){
    window.location.href = window.location.href;
}
var IDS = "ga:101800494";
var FILTERS = 'ga:pagePath=~/collab/1655(\/.*|$)';
var RT_FILTERS = 'rt:pagePath=~/collab/1655(\/.*|$)';
var DIMENSIONS = 'rt:pagePath=~/collab/1655(\/.*|$)';
var REFRESH_TIME = 120000;

document.getElementById("apply-btn").onclick = executeHistoryStat;
document.getElementById("refresh-btn").onclick = executeRealTimeStat;


function executeHistoryStat(){
    plotGeo(IDS, FILTERS);
    plotSessionNum(IDS, FILTERS);
    plotUserNum(IDS, FILTERS);
        plotHistoryUsecases();
}

function executeRealTimeStat(){
    plotRtUsers(IDS, FILTERS);
    plotRtPages(IDS, FILTERS);
    plotRtUsecases();
}

/* get real time users - start */
function plotRtUsers(IDS, FILTERS){
    gapi.client.analytics.data.realtime.get({ids:IDS,metrics:"rt:activeUsers", filters:FILTERS}).then(function(t){
        var element = document.getElementById("active-users-container");
        var value_el = document.getElementById("active-users-value");
        var active_users = t.result.totalResults?+t.result.rows[0][0]:0; 

        crr_act_users = parseInt(value_el.innerHTML);
        var delta = parseInt(active_users - crr_act_users);
        var animationClass = "";
        if (delta>0)
            animationClass = 'is-increasing';
        else if (delta < 0)
            animationClass = 'is-decreasing';
        element.className += (' ' + animationClass);

        value_el.innerHTML = active_users;

        setClassChangeTimeout(element)
    });
}
/* get real time users - end */

function setClassChangeTimeout(element){
    setTimeout(function() {
        element.className =
            element.className.replace(/ is-(increasing|decreasing)/g, '');
    }, 4000);
}

/* get real time pages- start */
function plotRtPages(IDS, FILTERS){
    gapi.client.analytics.data.realtime.get({ids:IDS, dimensions:"rt:pagePath,rt:pageTitle,rt:minutesAgo", metrics:"rt:pageviews", filters:FILTERS}).then(function(t){
        if (!("result" in t) || !("rows" in t.result)){
            data = {
                datasets:[{data:[1]}],
                labels:["No visit"]
            }
        }else{
            var pages = {};
            var labels = {};
            var data = {};
            t.result.rows.forEach(function(row, i) {
                if (parseInt(row[2]) >= 0 && parseInt(row[2]) <= 5){
                    pages[row[0]] = pages[row[0]] ? pages[row[0]]+(+row[3]):+row[3];
                    labels[row[0]] = labels[row[0]] ? labels[row[0]]:row[1];
                }
            });
            if (Object.getOwnPropertyNames(pages).length == 0){
                data = {
                    datasets:[{data:[1],
                        backgroundColor: palette('tol', 1).map(function(hex) {
                            return '#' + hex;
                        })
                    }],
                    labels:["No visit"]
                }
            } else {
                var data_all = [];
                var labels_str = [];
                var tooltips = [];
                Object.keys(labels).forEach(function(key, index) {
                    data_all.push(pages[key]);
                    labels_str.push(labels[key]);
                    tooltips.push(labels[key].substr(0,labels[key].indexOf(' ')));
                });  
                data = { 
                    labels:tooltips,
                    datasets:[{
                        data:data_all,
                        backgroundColor: palette('tol', data_all.length).map(function(hex) {
                            return '#' + hex;
                        })
                    }]
                };
            }
        }
        var ctx = makeCanvas('chart-rt-pages-container');
        var chart = new Chart(ctx, {
            type: 'doughnut',
            // The data for our dataset
            data: data,
            options: {
                legend:{
                    position: 'top',
                    labels:{
                        boxWidth: 10,
                    }
                }
            },
        });
    });
}
/* plot  real time pages- end */
function plotHistoryUsecases(){
    var dates = getDates();
    $.getJSON('/bsp-monitor/get-uc/' + dates[0] + '/' + dates[1] + '/', function (resp){
        var uc_hist_div = document.getElementById("uc-hist-div");
        uc_hist_div.innerHTML = "";
        var all_data = resp["uc_topics_full"];
        for (var key in all_data){
            var crr_global_container = document.createElement("div");
            var crr_figure = document.createElement("figure");
            var crr_legend_container = document.createElement("div");
            var crr_legend = document.createElement("ol");
            var crr_legend_id = key + "-legend";

            crr_global_container.setAttribute("class", "uc-t-box");
            //
            crr_figure.setAttribute('id', key);
            crr_figure.setAttribute("class", "hist-boxes");
            //

            crr_legend.setAttribute("class", "Chartjs-legend");
            crr_legend.setAttribute("class", "Chartjs-legend center-container legends");
            crr_legend.setAttribute("id", crr_legend_id);
            //
            crr_global_container.appendChild(crr_figure);
            crr_global_container.appendChild(crr_legend);
            uc_hist_div.appendChild(crr_global_container);
            var crr_t_labels = [];
            var crr_t_plot_labels = [];
            var crr_t_data = [];
            var data = {};
            var ctx = makeCanvas(key);
            if (resp["Response"] == "KO"){
                data = {
                    datasets:[{data:[]}],
                    labels:["No use case cloned"]
                } 
            } else {
                for (var yy in resp["uc_topics_full"][key]){
                    crr_t_labels.push(yy);
                    crr_t_plot_labels.push("");
                    crr_t_data.push(resp["uc_topics_full"][key][yy]);
                }
            } 

            data = {
                labels: crr_t_labels,
                datasets: [{data: crr_t_data,
                    label: key, 
                    backgroundColor: palette('tol', crr_t_data.length).map(function(hex) {
                        return '#' + hex;
                    })
                }]
            }
            var chart = new Chart(ctx, {
                type: 'bar',
                // The data for our dataset
                data: data,
                options: {
                    legend: {display: false},
                    title: {
                        display: true,
                        text: 'Number of cloned use cases for: ' + key,
                        fontSize: 16,
                    },
                    scales: {
                        xAxes: [{
                            display: false,
                        }],
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    },
                }
            });
            generateLegend2(crr_legend_id, data, crr_t_labels);
        }
    })
}

/**
 * Create a visual legend inside the specified element based off of a
 * Chart.js dataset.
 * @param {string} id The id attribute of the element to host the legend.
 * @param {Array.<Object>} items A list of labels and colors for the legend.
 */
function generateLegend(id, items) {
    var legend = document.getElementById(id);
    legend.innerHTML = items.map(function(item) {
        var color = item.color || item.fillColor;
        var label = item.label;
        return '<li><i style="background:' + color + '"></i>' +
            escapeHtml(label) + '</li>';
    }).join('');
}


function generateLegend2(id, items, labels){
    var legend = document.getElementById(id);
    var data = items.datasets[0].data;
    var colors = items.datasets[0].backgroundColor;
    var innHtml = ""; 
    for (var i=0; i < data.length; i++){
        innHtml = innHtml + '<li><i style="background:' + colors[i] + '"></i>' + escapeHtml(labels[i]) + '</li>';  
    }
    legend.innerHTML = innHtml;
}

/**
 * Escapes a potentially unsafe HTML string.
 * @param {string} str An string that may contain HTML entities.
 * @return {string} The HTML-escaped string.
 */
function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
}

function plotRtUsecases(){
    $.getJSON('/bsp-monitor/get-uc/0/0/', function (resp){
        document.getElementById("rt-uc-num").innerHTML = resp["rt_uc_num"];
        var data = {};
        if (resp["rt_uc_num"] == 0){
            data = {
                datasets:[{data:[1], 
                    backgroundColor: palette('tol', 1).map(function(hex) {
                        return '#' + hex;
                    })

                }],
                labels:["No use case cloned"]
            } 
        }
        else {
            data = {
                datasets:[{data:resp["uc_topics_count"],
                    backgroundColor: palette('tol', resp["uc_topics_count"].length).map(function(hex) {
                        return '#' + hex;
                    })
                }],
                labels:resp["uc_topics"]
            } 
        }
        var ctx = makeCanvas('chart-rt-uc-container');
        var chart = new Chart(ctx, {
            type: 'doughnut',
            // The data for our dataset
            data: data,
            options: {
                legend:{
                    position: 'top',
                    labels:{
                        boxWidth: 10,
                    }
                }
            },
        });
    })
}


/* plot # of sessions */
function plotSessionNum(IDS, FILTERS){
    var dates = getDates();
    var session_num = query({
        'ids': IDS,
        'filters': FILTERS,
        'dimensions': 'ga:date',
        'metrics': 'ga:sessions',
        'start-date': dates[0],
        'end-date': dates[1]
    });
    Promise.all([session_num]).then(function(results) {

        var data1 = results[0].rows.map(function(row) { return +row[1]; });
        var labels = results[0].rows.map(function(row) { return +row[0]; });
        labels = labels.map(function(label) {
            return moment(label, 'YYYYMMDD').format('DD-MM');
        });

        var data = {
            labels : labels,
            datasets : [
            {
                data : data1,
                pointRadius : 1,
                pointHoverRadius : 3,
                label: "# sessions",
            },
            ]
        };

        var ctx = makeCanvas('session-num');
        var chart = new Chart(ctx, {
            type: 'line',
            // The data for our dataset
            data: data,
            options: {
                legend: {display: false},
                title: {
                    display: true,
                    text: 'Number of sessions (Google Analytics)',
                    fontSize: 16,
                },
            }
        });
    });
}
/* plot # of users */
function plotUserNum(IDS, FILTERS){
    var dates = getDates();
    var user_num = query({
        'ids': IDS,
        'filters': FILTERS,
        'dimensions': 'ga:date',
        'metrics': 'ga:users',
        'start-date': dates[0],
        'end-date': dates[1]
    });
    Promise.all([user_num]).then(function(results) {

        var data1 = results[0].rows.map(function(row) { return +row[1]; });
        var labels = results[0].rows.map(function(row) { return +row[0]; });
        labels = labels.map(function(label) {
            return moment(label, 'YYYYMMDD').format('DD-MM');
        });

        var data = {
            labels : labels,
            datasets : [
            {
                data : data1,
                pointRadius : 1,
                pointHoverRadius : 3,
            },
            ]
        };
        var ctx = makeCanvas('user-num');
        var chart = new Chart(ctx, {
            type: 'line',
            // The data for our dataset
            data: data,
            label: "# users",
            options: {
                legend: {display: false},
                title: {
                    display: true,
                    text: 'Number of users (Google Analytics)',
                    fontSize: 16,
                },
            }
        });
    });
}

/* get dates from html element */
function getDates(){
    var from_day = document.getElementById("from-day").value;
    var to_day = document.getElementById("to-day").value;
    return [from_day, to_day]
}

/**
 * Extend the Embed APIs `gapi.analytics.report.Data` component to
 * return a promise the is fulfilled with the value returned by the API.
 * @param {Object} params The request parameters.
 * @return {Promise} A promise.
 */
function query(params) {
    if (!(params['filters'])){
        params['filters'] = 'ga:pagePath=~/collab/1655(\/.*|$)';
    }
    return new Promise(function(resolve, reject) {
        var data = new gapi.analytics.report.Data({query: params});
        data.once('success', function(response) { resolve(response); })
            .once('error', function(response) { reject(response); })
            .execute();
    });
}

/* plot Geography of sessions - start */
function plotGeo(IDS, FILTERS){
    var dates = getDates();
    var dataChart = new gapi.analytics.googleCharts.DataChart({
        query: {
            ids: IDS,
            metrics: 'ga:sessions',
            dimensions: 'ga:country',
            'sort': '-ga:sessions',
            "start-date": dates[0],
            "end-date": dates[1]
        },
        chart: {
            container: 'embed-geo',
            type: 'GEO',
            options: {
                width: '100%',
                title: "Locations (Google Analytics)",
                fontSize: 16,
            }
        }
    });
    dataChart.execute();
}
/* plot Geography of sessions - end */

/* set dates in calendar inputs - start */

var todayUtc = moment.utc();
var todayUtcFormat = todayUtc.format("YYYY-MM-DD");
var todayToDate = moment.utc(todayUtcFormat).toDate();
var today = moment(todayToDate).local().format("YYYY-MM-DD");

var lastMonthUtc = moment.utc().subtract(1, "month");
var lastMonthUtcFormat = lastMonthUtc.format("YYYY-MM-DD");
var lastMonthToDate = moment.utc(lastMonthUtcFormat).toDate();
var lastMonth = moment(lastMonthToDate).local().format("YYYY-MM-DD");

var from_day = document.getElementById("from-day");
var to_day = document.getElementById("to-day");

from_day.setAttribute("value", lastMonth);
to_day.setAttribute("value", today);

// manage from_day.onchange function
from_day.onchange = function(){
    var from_day = document.getElementById("from-day");
    var to_day = document.getElementById("to-day");
    from_day.value = this.value;
    var to_day_crr_value = to_day.value;
    var to_day_crr_date = moment(to_day_crr_value);
    var from_day_crr_value = this.value;
    var from_day_crr_date = moment(from_day_crr_value);
    var date_diff = to_day_crr_date.diff(from_day_crr_date, 'days');
    if (date_diff < 0)
                                    to_day.value = this.value;
                                    }


                                    // manage to_day.onchange function
                                    to_day.onchange = function(){
                                    var from_day = document.getElementById("from-day");
                                    var from_day_crr_value = from_day.value;
                                    var from_day_crr_date = moment(from_day_crr_value);
                                    to_day.setAttribute("value", this.value);
                                    var to_day_crr_date = moment(this.value);
                                    var date_diff = to_day_crr_date.diff(from_day_crr_date, 'days');
                                    if (date_diff < 0){
                                    from_day.value = this.value;
                                    }
                                    }


                                    /**
                                    * Create a new canvas inside the specified element. Set it to be the width
                                    * and height of its container.
                                    * @param {string} id The id attribute of the element to host the canvas.
                                    * @return {RenderingContext} The 2D canvas context.
                                    */
                                    function makeCanvas(id) {
                                    var container = document.getElementById(id);
                                    var canvas = document.createElement('canvas');
                                    var ctx = canvas.getContext('2d');

                                    container.innerHTML = '';
                                    canvas.width = container.offsetWidth;
                                    canvas.height = container.offsetHeight;
                                    container.appendChild(canvas);

                                    return ctx;
                                    }



                                    gapi.analytics.ready(function() {
                                    $.getJSON("/bsp-monitor/get-access-token/ganalytics/", function(data){
                                    gapi.analytics.auth.authorize({
                                    'serverAuth': {
                                    'access_token': data["access_token_ganalytics"]
                                    }
                                    });

                                    plotRtUsers(IDS, RT_FILTERS);
                                    plotRtPages(IDS, RT_FILTERS);
                                    plotGeo(IDS, FILTERS);
                                    plotSessionNum(IDS, FILTERS);
                                    plotUserNum(IDS, FILTERS);
                                    plotRtUsecases();
                                    plotHistoryUsecases();

                                    setInterval(function(){
                                    plotRtUsers(IDS, RT_FILTERS);
                                    plotRtPages(IDS, FILTERS);
                                    }, REFRESH_TIME);
                                    })
                                    })
            </script>

    </body>
</html>
